!function(e){function t(){}t.prototype.getNumberOfProperties=function(e,t){if(void 0===e)return 0;var n=e;return t&&(n=e[t]),Object.keys(n).length},e.synth=e.synth||{},e.synth.utilities=new t}(window);var synthMobile=angular.module("SynthMobile",["ngRoute","ngAnimate","ab-base64","ui.bootstrap","frapontillo.bootstrap-switch","ng-iscroll"]);!function(e){"use strict";e.config(["$routeProvider","$compileProvider",function(e,t){t.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|file|cdvfile):|data:image\//),e.when("/boot",{templateUrl:"base/partials/boot.html",controller:"BootCtrl"}).when("/boot/:moduleId",{templateUrl:"base/partials/boot.html",controller:"BootCtrl"}).when("/home",{templateUrl:"base/partials/toolSelect.html",controller:"HomeCtrl"}).when("/settings",{templateUrl:"base/partials/settings.html",controller:"SettingsCtrl"}).when("/settings-sync",{templateUrl:"base/partials/settings-sync.html",controller:"SettingsSyncCtrl"}).when("/settings-chooseModules",{templateUrl:"base/partials/selectModules.html",controller:"SettingsSelectModulesCtrl"}).when("/sync",{templateUrl:"base/partials/sync.html",controller:"SyncCtrl"}).when("/sync-configure",{templateUrl:"base/partials/sync-configure.html",controller:"SyncConfigureCtrl"}).when("/sync-progress",{templateUrl:"base/partials/sync-progress.html",controller:"SyncProgressCtrl"}).when("/register",{templateUrl:"base/partials/login.html",controller:"RegisterCtrl"}).when("/register-selectModules",{templateUrl:"base/partials/selectModules.html",controller:"RegisterSelectModuleCtrl"}).when("/register-modulesRegistration",{templateUrl:"base/partials/registerModules.html",controller:"RegisterModuleRegistrationCtrl"}).otherwise({redirectTo:"/boot"})}]).factory("SynthQLoop",["$q",function(e){return function(t){function n(){var e=t();null==e?o.resolve():e.then(n,function(e){o.reject(e)})}var o=e.defer();return{then:function(e,t,r){return n(),o.promise.then(e,t,r)},notify:function(){console.log("need to update")}}}}]).factory("SynthQIfStatement",["$q",function(e){return function(t,n,o){var r=e.defer();return t().then(function(e){var t=e?n:o;return null==t?void r.resolve():void t().then(function(){r.resolve()},function(e){r.reject(e)})},function(e){r.reject(e)}),r.promise}}]).factory("UserSession",[function(){return{username:null,authToken:null,deviceId:null,modules:{},registered:!1,activeModule:null,updateSession:function(e){for(var t in e)this[t]=e[t]},clearSession:function(){for(var e in this)"function"!=typeof this[e]&&(this[e]=null)}}}]).factory("SynthError",["$http",function(e){var t={};return e({method:"GET",url:"base/data/errorMessages.json"}).success(function(e){t=e}).error(function(){}),function(e,n){if(e instanceof Error){var o=angular.copy(t[1e3]);return o.additional=e.message,o}if("object"==typeof e)return{id:e.errorCode,errorMessage:e.message,errorInstruction:e.instruction,additional:n};var o=angular.copy(t[e]);return n&&(o.additional=n),o}}]).factory("SynthFail",[function(){return function(e){return function(t){e.reject(t)}}}]).factory("SynthCheckResponseError",["SynthError","LoggerService","DataService","UserSession",function(e,t,n,o){var r=t("SynthCheckResponseError");return function(t,i){if(2002===i.errorCode){var a={authToken:null};o.updateSession(a),n.mergeToRegistrationData(a)}return void 0===i.status?!1:"SUCCESS"===i.status?!1:(r.isWARN()&&r.warn("Got error response : "+JSON.stringify(i)),null!=t&&t.reject(e(i)),!0)}}]).factory("SynthErrorHandler",["$q","$rootScope","SynthError",function(e,t,n){return function(o){return o instanceof Error&&(o=n(o)),t.synthError=o,$("#synthErrorModal").modal("show"),e.reject(o)}}]).factory("AppSyncStatus",["$rootScope",function(){return{inSync:!1,tools:{},allOutSync:function(){this.inSync=!1,this.tools={}},update:function(e,t){null==t?this.inSync=!1:(this.tools=this.tools||{},this.tools[t]=this.tools[t]||{},this.tools[t].inSync=e)},updateTools:function(e){this.tools=null==e?{}:e}}}]).factory("SynthAuthenticateUser",["$q","UserSession","SyncAPIService","$rootScope",function(e,t,n,o){return{FAILED:"1",SUCCESS:"0",CANCELLED:"2",login:function(r,i){function a(){o.authenticationModel=null,o.authenticationOk=null,o.authenticationCancelled=null}var c=e.defer();return null!=t.authToken?(c.resolve({code:0,username:t.username,authToken:t.authToken}),c.promise):(o.authenticationModel={username:t.username,password:null,authFailed:!1,message:null,instruction:null,submitText:i?i:"Authenticate",titleText:r?r:"Please enter password"},o.authenticationOk=function(){n.authenticateUser(o.authenticationModel.username,o.authenticationModel.password).then(function(e){e.authenticated?($("#synthAuthenticationModal").modal("hide"),t.authToken=e.authToken,c.resolve({code:0,username:o.authenticationModel.username,password:o.authenticationModel.password}),a()):(o.authenticationModel.message=e.message,o.authenticationModel.instruction=e.instruction,o.authenticationModel.password=null,o.authenticationModel.authFailed=!0)},function(e){$("#synthAuthenticationModal").modal("hide"),a(),c.reject(e)})},o.authenticationCancelled=function(){$("#synthAuthenticationModal").modal("hide"),a(),c.resolve({code:2})},$("#synthAuthenticationModal").modal("show"),c.promise)}}}]).filter("noEscape",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]).filter("object2Array",function(){return function(e){var t=[];for(var n in e){var o=e[n];o.key=n,t.push(o)}return t}}).filter("array2Object",function(){return function(e,t){var n={};t=t||"id";for(var o=0;o<e.length;o++){var r=e[o];n[r[t]]=r}return n}}).filter("formatDate",function(){return function(e,t){return t||(t="YYYY-MM-DD h:mm a"),null===e||""===e?"":moment(e).format(t)}}).filter("bytesToSize",function(){return function(e,t){var n=["B","KB","MB","GB","TB"];if(t&&0===e)return"0";if(void 0===e||0===e)return"n/a";var o=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return 0===o?e+" "+n[o]:(e/Math.pow(1024,o)).toFixed(1)+" "+n[o]}}).filter("attachments",function(){return function(e){var t=[];for(var n in e){var o=e[n];o.link===!1&&t.push(o)}return t}}).controller("AppController",["$scope","$routeParams","$window","UserSession","UserService","SynthConfig","AppSyncStatus","SyncService",function(e,t,n,o,r,i,a,c){function s(){c.stopBackgroundSync()}function l(){c.startBackgroundSync()}e.linkVendor=function(){window.open(i.vendorURL,"_system")},e.vendorName=i.vendorName,e.applicationName=i.applicationName,e.userSession=o,e.appSyncStatus=a,document.addEventListener("pause",s,!1),document.addEventListener("resume",l,!1),e.myScrollOptions=e.myScrollOptions||{},e.myScrollOptions.menuScroll={scrollbars:!0},e.goBack=function(){"home"===e.activePage||"register"===e.activePage||"boot"===e.activePage?"iOS"!==device.platform&&navigator.notification.confirm("Are you sure you want to exit the application?",function(e){2===e&&navigator.app.exitApp()},"Exit Application",["No","Yes"]):navigator.app.backHistory()},document.addEventListener("backbutton",function(){e.goBack()},!1)}])}(synthMobile);var SynthAttachmentMiner={addHandler:function(e,t){null==this.handlers&&(this.handlers={}),null==this.handlers[e]&&(this.handlers[e]="string"==typeof t&&"default"===t?this.defaultHandler:t)},getHandler:function(e){return null==this.handlers?null:this.handlers[e]},parseArray:function(e,t){var n=[];if(e)for(var o=0;o<e.length;o++)null!=e[o].downloadKey&&(e[o].downloadPath=t+"/"+e[o].downloadPath,n.push(e[o]));return n},defaultHandler:function(e,t){var n=[];for(var o in e)n=n.concat(SynthAttachmentMiner.parseArray(e[o].attachments,t));return n}},SynthEmbeddedImageHandler={addHandler:function(e,t){null==this.handlers&&(this.handlers={}),null==this.handlers[e]&&(this.handlers[e]=t)},getHandler:function(e){return null==this.handlers?null:this.handlers[e]},fixForHtmlElement:function(e,t){var n=$("<div/>").html(e);return n.find("img").each(function(){$(this).attr("src",t+"/"+$(this).attr("src"))}),n.html()}},SynthUploadResponseHandler={addHandler:function(e,t){null==this.handlers&&(this.handlers={}),null==this.handlers[e]&&(this.handlers[e]=t)},getHandler:function(e){return null==this.handlers?null:this.handlers[e]}},SynthLinkHandler={addHandler:function(e,t){null==this.handlers&&(this.handlers={}),null==this.handlers[e]&&(this.handlers[e]=t)},getHandler:function(e){return null==this.handlers?null:this.handlers[e]},fixContent:function(e){var t=$("<div/>").html(e);return t.find("a[href]").each(function(){var e=$(this).attr("href");$(this).attr("href","javascript:window.open('"+e+"', '_system');")}),t.html()}};!function(e){"use strict";e.factory("SynthConfig",[function(){return{applicationName:"SynthMobile",vendorName:"OpenCollab",vendorURL:"http://www.opencollab.co.za",dataDir:"SynthMobile",logLevel:1,logToConsole:!0,logToFile:!0,logFileSize:1e6,logFileCount:5,baseURL:"http://unipoole.ac.za/unipoole-service",toolMapping:{"sakai.announcements":"announcements",announcements:"sakai.announcements","unisa.faqs":"faq",faq:"unisa.faqs","sakai.yaft":"forums",forums:"sakai.yaft","unisa.welcome":"welcome",welcome:"unisa.welcome","sakai.schedule":"schedule",schedule:"sakai.schedule","client.base":"base",base:"client.base",learning_units:"sakai.melete","sakai.melete":"learning_units",resources:"sakai.resources","sakai.resources":"resources"}}}])}(synthMobile),function(e){"use strict";e.directive("synthMenu",["$window","UserSession","AppSyncStatus",function(e,t,n){return{restrict:"E",scope:!1,templateUrl:"base/partials/directives/menu.html",link:function(o){o.menuOpen=!1,o.toggleMenu=function(){o.menuOpen=!o.menuOpen},o.openSync=function(){o.menuOpen=!1,t.registered&&(e.location="#/sync")},o.getSyncClass=function(){return n.downloading?"glyphicon-cloud-download outSync syncBusy":n.uploading?"glyphicon-cloud-upload outSync syncBusy":n.inSync?"glyphicon-cloud inSync":"glyphicon-cloud outSync"}}}}]).directive("synthFooter",function(){return{restrict:"E",scope:!1,templateUrl:"base/partials/directives/footer.html"}}).directive("synthModuleDropdown",["$window","UserSession",function(e,t){return{restrict:"A",templateUrl:"base/partials/directives/moduleDropdown.html",link:function(n){n.changeModule=function(t){e.location="#/boot/"+t.id},n.numberModules=function(){return null==t.modules?0:Object.keys(t.modules).length}}}}]).directive("synthAttachments",["$filter",function(e){return{restrict:"E",templateUrl:"base/partials/directives/attachments.html",scope:{attachments:"="},link:function(t,n,o){t.openAttachment=function(e){window.plugins.fileOpener.open(e.downloadPath,function(){},function(e){alert(e)})},t.attachments=e("attachments")(t.attachments),t.buttonPull=o.pull?"right"===o.pull?"pull-right":"left"===o.pull?"pull-left":null:null}}}]).directive("bootSpinner",function(){return{restrict:"E",scope:!1,link:function(e,t){{var n={lines:15,length:0,width:30,radius:90,corners:1,rotate:0,direction:1,color:"#000",speed:1,trail:35,shadow:!1,hwaccel:!0,className:"spinner",zIndex:2e9,top:"50%",left:"50%"};new Spinner(n).spin(t[0])}}}})}(synthMobile),function(e){e.controller("BootCtrl",["$rootScope","$window","$routeParams","DataService","UserService","UserSession","SyncAPIService","SynthErrorHandler","SyncService",function(e,t,n,o,r,i,a,c,s){e.activePage="boot",i.registered=!1;var l=[];e.status=l,e.applicationBoot=!0;var u=n.moduleId;l.push("Initialising..."),null!=u&&(l.push("Loading module : "+u),e.tools=null);var d=function(){return l.push("Checking settings..."),o.ensureSettingsData().then(function(e){i.updateSession({settings:e})})},f=function(){return l.push("Checking sync status..."),a.getSyncStatusOffline(i.activeModule)},h=function(){return l.push("Checking registration progress..."),r.getRegistrationProgress()},g=function(){return l.push("Loading registration..."),o.getRegistrationData().then(function(e){i.updateSession(e),i.activeModule=null!=u?u:e.defaultModule})},p=function(n){return r.PROGRESS_COMPLETED===n?(s.startBackgroundSync(),i.registered=!0,f().then(function(){t.location="#/home",e.applicationBoot=!1})):void(r.PROGRESS_SELECT_MODULES===n?(t.location="#/register-selectModules",e.applicationBoot=!1):(t.location="#/register",e.applicationBoot=!1))};d().then(g).then(h).then(p,c)}])}(synthMobile),function(e){"use strict";e.controller("SettingsCtrl",["$scope","$rootScope","$window","LoggerService","DataService","AppSyncStatus","SynthErrorHandler","UserSession","SyncService",function(e,t,n,o,r,i,a,c,s){o("SettingsCtrl");t.activePage="settings",t.breadcrumbs=[{name:"Settings"}],e.deleteApplicationData=function(){r.deleteAllApplicationData().then(function(){s.stopBackgroundSync(),i.allOutSync(),t.tools=null,c.clearSession(),n.location="#/boot"},a)},e.animateSwitch=!1,e.autoSyncDownload=c.settings&&c.settings.autoSyncDownload,e.autoSyncUpload=c.settings&&c.settings.autoSyncUpload,e.animateSwitch=!0,e.modules=c.modules,e.defaultModule=c.defaultModule,e.numModules=null==c.modules?0:Object.keys(c.modules).length,e.selectDefaultModule=function(t,n){n.stopPropagation();var o={defaultModule:t};r.mergeToRegistrationData(o).then(function(){e.defaultModule=t,c.defaultModule=t})},e.$watch("autoSyncDownload",function(e){r.mergeToSettingsData({autoSyncDownload:e}),c.settings.autoSyncDownload=e,c.settings.autoSyncDownload||c.settings.autoSyncUpload?s.startBackgroundSync():s.stopBackgroundSync()}),e.$watch("autoSyncUpload",function(e){r.mergeToSettingsData({autoSyncUpload:e}),c.settings.autoSyncUpload=e,c.settings.autoSyncDownload||c.settings.autoSyncUpload?s.startBackgroundSync():s.stopBackgroundSync()})}]).controller("SettingsSelectModulesCtrl",["$scope","$rootScope",function(e,t){t.breadcrumbs=[{name:"Settings"},{name:"Select Modules"}];var n=[],o=[],r=function(){return SyncAPIService.getAllowedSites().then(function(e){n=e})},i=function(){return UserService.getRegistrationData().then(function(e){o=e.modules})},a=function(){};r().then(i).then(a)}])}(synthMobile),function(e){"use strict";e.factory("RegisterService",["$q","$filter","DataService","SyncAPIService","LoggerService","SynthFail","SynthCheckResponseError","SynthQLoop",function(e,t,n,o,r,i,a,c){function s(){}var l=r("RegisterService");return s.prototype.initModules=function(e){function t(){return o==e.length?null:n._createModuleStructure(e[o++].id)}l.debug("initModules()");var n=this,o=0;return c(t)},s.prototype.registerModules=function(e){function t(){if(r==e.length)return null;var t=e[r++];return o.registerForModule(t.id).then(function(e){var t={lmsId:e.userDetails["lms-id"],displayName:e.userDetails["display-name"]};return n.mergeToRegistrationData(t)}).then(function(){return o.updateModuleData(t.id)})}var r=0;return c(t)},s.prototype._createModuleStructure=function(e){function t(){if(i==o.length)return null;var t=o[i++];return r._createToolDataFile(e,t.id)}function n(){return r._getModuleTools(e).then(function(e){o=e})}var o,r=this,i=0;return this._createModuleDataFile(e).then(n).then(c(t))},s.prototype._createModuleDataFile=function(e){return n.copyFromWebToFile("base/data/module.json",e,"module.json")},s.prototype._createToolDataFile=function(e,t){return n.writeToFile(e+"/tools/"+t+"/data",t+".json","{}")},s.prototype._getModuleTools=function(o){var r=e.defer();return n.getModuleData(o).then(function(e){var n=t("object2Array")(e.toolsLocal);l.isDEBUG()&&l.debug("Got module tools : "+JSON.stringify(n)),r.resolve(n)},function(e){r.reject(e)}),r.promise},new s}])}(synthMobile),function(e){e.controller("RegisterCtrl",["$scope","$rootScope","$window","$q","SyncAPIService","UserSession","DataService","LoggerService","SynthErrorHandler","SynthError",function(e,t,n,o,r,i,a,c,s,l){c("RegisterCtrl");t.activePage="register",t.breadcrumbs=[{name:"Register"}],e.authFailed=!1,e.login=i;var u=function(){var t=e.login.username,n=e.login.password;return r.authenticateUser(t,n).then(function(e){return e.authenticated?void 0:o.reject(l(e))})},d=function(){n.location="#/register-selectModules"};e.submit=function(){u().then(d,s)}}]).controller("RegisterSelectModuleCtrl",["$scope","$rootScope","$window","UserSession","DataService","LoggerService","SyncAPIService","SynthErrorHandler",function(e,t,n,o,r,i,a,c){i("RegisterSelectModuleCtrl");t.activePage="register-selectModule",t.breadcrumbs=[{name:"Select Modules"}],e.login=o,e.error=!1,e.canContinue=!1,e.loadingModules=!0;var s=!0,l=function(){return a.getAllowedSites()},u=function(){for(var e=d(),t={},n=0;n<e.length;n++){var i=e[n];t[i.id]=i}o.registration=o.registration||{},o.registration.modules=t;var a={deviceId:device.uuid};return r.mergeToRegistrationData(a).then(function(){o.updateSession(a)})},d=function(){var t=e.modules;if(null==t)return null;for(var n=[],o=0;o<t.length;o++)if(t[o].selected&&!t[o].registered){var r=angular.copy(t[o]);delete r.selected,n.push(r)}return n},f=function(){var e=d();return null==e?null:e[0]},h=function(){return null!=f()},g=function(){e.errorMessage="You must select atleast one module",e.error=!0,e.canContinue=!1};l().then(function(t){if(e.loadingModules=!1,0==t.length)e.errorMessage="You are not registered for any modules",e.error=!1;else{if(o.modules)for(var n in t){var r=t[n];null!=o.modules[r.id]&&(r.registered=!0)}e.modules=t}},function(t){e.loadingModules=!1,c(t).then(function(){},function(){e.errorMessage="Failed to retrieve modules",e.error=!0})}),e.toggleModule=function(e){e.registered||(e.selected=!e.selected)},e.hasSelectedModules=h,e.$watch("hasSelectedModules()",function(t){s||t?(e.error=!1,e.canContinue=!0,s=!1):g()}),e.submit=function(){h()?u().then(function(){n.location="#/register-modulesRegistration"},c):(e.errorMessage="You must select atleast one module",e.error=!0)}}]).controller("RegisterModuleRegistrationCtrl",["$scope","$rootScope","$window","UserSession","DataService","RegisterService","LoggerService","SynthErrorHandler",function(e,t,n,o,r,i,a,c){function s(){var e=[];for(var t in o.registration.modules)o.modules&&null!=o.modules[t]||e.push(o.registration.modules[t]);return e}var l=a("RegisterModuleRegistrationCtrl");if(t.activePage="register-moduleRegistration",t.breadcrumbs=[{name:"Registering Modules"}],e.error=!1,e.busy=!0,null==o.registration.modules)return l.info("There are no modules for active user"),void(n.location="#/register");var u=s();if(e.modules=u,0==u.length)return void(n.location="#/home");var d=function(){return i.initModules(u)},f=function(){return i.registerModules(u)},h=function(){e.busy=!1,n.location="#/sync"},g=function(t){c(t).then(function(){},function(){l.error("Error while trying to register for modules"),e.error=!0,e.busy=!1})},p=function(){o.registered=!0;var e=jQuery.extend(!0,o.modules,o.registration.modules);o.modules=e;var t={modules:e};return null==o.defaultModule&&(t.defaultModule=u[0].name,o.defaultModule=u[0].name),o.activeModule=u[0].name,r.mergeToRegistrationData(t)};d().then(f).then(p).then(h,g)}])}(synthMobile),function(e){"use strict";e.factory("HomeService",["$q","$filter","DataService","LoggerService","UserSession","SynthFail",function(e,t,n,o,r,i){function a(){}o("HomeService");return a.prototype.getHomeTools=function(){var o=e.defer();return n.getModuleData(r.activeModule).then(function(e){var n=e.toolDescriptions,r=t("object2Array")(n);r=t("filter")(r,{menu:!0}),r=t("orderBy")(r,"seq"),o.resolve(r)},i(o)),o.promise},new a}])}(synthMobile),function(e){e.controller("HomeCtrl",["$scope","$rootScope","$filter","$window","HomeService","LoggerService","SynthErrorHandler",function(e,t,n,o,r,i,a){i("HomeCtrl");t.activePage="home",t.breadcrumbs=[{name:"Home"}],r.getHomeTools().then(function(e){t.tools=e},a)}])}(synthMobile),function(e){"use strict";e.factory("SyncService",["$q","$timeout","SyncAPIService","DataService","LoggerService","UserSession","AppSyncStatus","SynthQLoop","SyncSelection",function(e,t,n,o,r,i,a,c,s){function l(){}var u=r("SyncService"),d=null;return l.prototype.getSyncDetails=function(){return n.getSyncStatus(i.activeModule)},l.prototype.syncDownloadTool=function(e){return n.syncDownloadTool(i.activeModule,e)},l.prototype.syncSelected=function(e){function t(){var e=null,t=d++;return t<a.length&&(e=l.syncDownloadTool(a[t].key).then(function(){u.debug("Completed download for tool : "+a[t].key),a[t].downloadProgress=100,"base"==a[t].key&&(s=!0)})),e}function o(){var e=null,t=f++;return t<i.length&&(e=l.syncUploadTool(i[t].key).then(function(){u.debug("Completed upload for tool : "+i[t].key),i[t].downloadProgress=100})),e}function r(){return n.getSyncStatusOffline()}var i=e.getUploadArray(),a=e.getDownloadArray(),s=!1,l=this,d=0,f=0;return c(t).then(function(){return c(o)}).then(r).then(function(){return{didUpdateBase:s}})},l.prototype.syncUploadTool=function(e){return n.syncUploadTool(i.activeModule,e)},l.prototype.startBackgroundSync=function(){var e=this;null==d?i.settings&&(i.settings.autoSyncDownload||i.settings.autoSyncUpload)?(u.debug("Starting background sync timer... "+i.settings.autoSyncInterval),d=t(function(){i.settings&&(i.settings.autoSyncDownload||i.settings.autoSyncUpload)&&e._handleTimedSync()},i.settings.autoSyncInterval)):u.debug("Not going to start sync, it is not enabled"):u.debug("Cannot start background sync again, already running...")},l.prototype._handleTimedSync=function(){u.debug("Need to check for sync now");var e=this;t.cancel(d),n.getSyncStatus().then(function(t){var n=s.newInstance();n.tools=t.tools,i.settings.autoSyncDownload&&n.selectAllDownloads(),i.settings.autoSyncUpload&&n.selectAllUploads(),e.syncSelected(n).then(function(){d=null,e.startBackgroundSync()})})},l.prototype.stopBackgroundSync=function(){u.debug("Stopping background sync timer..."),null!=d&&(t.cancel(d),d=null)},l.prototype.notifyChanges=function(e){a.tools[e].inSync=!1,a.inSync=!1,this._handleTimedSync()},new l}])}(synthMobile),function(e){"use strict";e.factory("SyncSelection",["LoggerService","HomeService",function(e){function t(){this.tools={}}var n=e("SyncSelection");return t.prototype.selectAll=function(){for(var e in this.tools)this.tools[e].downloadSelected=this.tools[e].contentDownloadSize+this.tools[e].codeDownloadSize>0,this.tools[e].uploadSelected=this.tools[e].contentUploadSize>0},t.prototype.selectAllDownloads=function(){for(var e in this.tools)this.tools[e].downloadSelected=this.tools[e].contentDownloadSize+this.tools[e].codeDownloadSize>0},t.prototype.selectAllUploads=function(){for(var e in this.tools)this.tools[e].uploadSelected=this.tools[e].contentUploadSize>0},t.prototype.getDownloadSize=function(){var e=0;for(var t in this.tools)this.tools[t].downloadSelected&&(e+=this.tools[t].contentDownloadSize+this.tools[t].codeDownloadSize);return e},t.prototype.getUploadSize=function(){var e=0;for(var t in this.tools)this.tools[t].uploadSelected&&(e+=this.tools[t].contentUploadSize);return e},t.prototype.getTotal=function(){return this.getDownloadSize()+this.getUploadSize()},t.prototype.getSyncableToolsArray=function(){var e=[];for(var t in this.tools)(this.tools[t].contentDownloadSize+this.tools[t].codeDownloadSize>0||this.tools[t].contentUploadSize>0)&&e.push(this.tools[t]);return e},t.prototype.getDownloadArray=function(){var e=[];for(var t in this.tools)n.debug(JSON.stringify(this.tools[t])),this.tools[t].downloadSelected&&(this.tools[t].key=t,e.push(this.tools[t]));return e},t.prototype.getUploadArray=function(){var e=[];for(var t in this.tools)this.tools[t].uploadSelected&&(this.tools[t].key=t,e.push(this.tools[t]));return e},t.prototype.newInstance=function(){return new t},new t}]).controller("SyncCtrl",["$scope","$rootScope","$window","SyncService","SyncSelection","LoggerService","SynthAuthenticateUser","SynthErrorHandler",function(e,t,n,o,r,i,a,c){var s=i("SyncCtrl");t.activePage="sync",t.breadcrumbs=[{name:"Sync Summary"}],e.haveSyncStatus=!1,o.getSyncDetails().then(function(t){e.syncSummary=t,e.haveSyncStatus=!0,r.tools=t.tools,r.selectAll()},c),e.doSync=function(){a.login("Please enter password","Sync").then(function(e){a.FAILED==e.code?s.warn("Authentication failed"):a.SUCCESS==e.code&&(n.location="#/sync-progress")})}}]).controller("SyncConfigureCtrl",["$scope","$rootScope","$window","SyncService","SyncSelection","LoggerService","SynthAuthenticateUser",function(e,t,n,o,r,i,a){var c=i("SyncConfigureCtrl");t.activePage="sync",t.breadcrumbs=[{name:"Sync",url:"#sync"},{name:"Configure"}],e.updateTotals=function(){e.syncUpload=r.getUploadSize(),e.syncDownload=r.getDownloadSize(),e.syncTotal=r.getTotal()},e.doSync=function(){a.login("Please enter password","Sync").then(function(e){a.FAILED==e.code?c.warn("Authentication failed"):a.SUCCESS==e.code&&(n.location="#/sync-progress")})},e.tools=r.getSyncableToolsArray(),e.updateTotals()}]).controller("SyncProgressCtrl",["$scope","$rootScope","$filter","$timeout","$q","SyncService","DataService","SyncAPIService","SynthQLoop","SyncSelection","LoggerService","HomeService","SynthErrorHandler","SynthAuthenticateUser",function(e,t,n,o,r,i,a,c,s,l,u,d,f,h){function g(e){return e.didUpdateBase===!0?d.getHomeTools().then(function(n){return t.tools=n,e}):r.when(e)}function p(){i.syncSelected(l).then(g).then(function(){m.debug("Synching of all tools completed without error"),e.syncBusy=!1},function(t){m.debug("Synching of all tools completed with errors!"),e.syncBusy=!1,e.syncError=!0,2002===t.id?h.login("Please enter password","Sync").then(function(e){h.FAILED==e.code?m.warn("Authentication failed"):h.SUCCESS==e.code&&p()}):f(t)})}var m=u("SyncProgressCtrl");t.activePage="sync",t.breadcrumbs=[{name:"Sync",url:"#sync"},{name:"Synchronising"}],e.syncError=!1,e.syncBusy=!0,e.toolUploads=l.getUploadArray(),e.toolDownloads=l.getDownloadArray(),p()}])}(synthMobile),function(e){"use strict";e.factory("SettingsService",["$q","$filter","DataService","LoggerService","UserSession",function(e,t,n,o){function r(){}o("SettingsService");return new r}])}(synthMobile),function(e){"use strict";e.factory("LoggerService",["$q","$log","$injector","SynthConfig","SynthQLoop",function(e,t,n,o,r){function i(){var t=e.defer();return w===!0?t.resolve():document.addEventListener("deviceready",function(){w=!0,t.resolve()},!1),t.promise}function a(){return i().then(function(){function n(e){e.root.getDirectory(o.dataDir,{create:!0,exclusive:!1},function(e){i.resolve(e)},r)}function r(e){t.warn("Failed to get filesystem, code:"+e.code),i.reject(e)}var i=e.defer();return window.requestFileSystem(LocalFileSystem.PERSISTENT,0,n,r),i.promise}).then(function(t){var n=e.defer();return t.getDirectory("logs",{create:!0},function(e){n.resolve(e)}),n.promise})}function c(t){return a().then(function(n){var o=e.defer();return n.getFile(t,{create:!0},function(e){o.resolve(e)},function(e){deferred.reject(e)}),o.promise})}function s(){var t=e.defer();return c("log."+v+".txt").then(function(e){e.remove(function(){t.resolve()},function(e){t.reject(e)})}),t.promise}function l(t){function n(e){o.reject(e)}var o=e.defer();return c("log."+t+".txt").then(function(e){e.getParent(function(r){e.moveTo(r,"log."+(t+1)+".txt",function(e){o.resolve(e)},n)},n)}),o.promise}function u(){function e(){return 0>n?null:l(n--)}function t(){return c("log.0.txt")}var n=v-1;return s().then(function(){return r(e)}).then(t)}function d(){u().then(function(e){return e})}function f(n){c("log.0.txt").then(function(o){function r(e){e.onwriteend=function(){a.resolve()},e.seek(e.length),e.write(n+"\n")}function i(e){t.warn("Failed while trying to write to file, error: "+e),deferred.reject(e)}var a=e.defer();return o.createWriter(r,i),a.promise})}function h(e){this.name=e}var g={},p={DEBUG:1,INFO:2,WARN:3,ERROR:4,NONE:5},m=o.logLevel,y=o.logToConsole,S=o.logToFile,v=o.logFileCount,w=!1;h.prototype.debug=function(e){if(this.isDEBUG()){var n=moment().format("YYYY-MM-DD HH:mm:ss")+" "+this.name+" (DEBUG) : "+e;y&&t.log(n),S&&f(n)}},h.prototype.warn=function(e){if(this.isWARN()){var n=moment().format("YYYY-MM-DD HH:mm:ss")+" "+this.name+" (WARN) : "+e;y&&t.warn(n),S&&f(n)}},h.prototype.info=function(e){if(this.isINFO()){var n=moment().format("YYYY-MM-DD HH:mm:ss")+" "+this.name+" (INFO) : "+e;y&&t.info(n),S&&f(n)}},h.prototype.error=function(e){if(this.isERROR()){var n=moment().format("YYYY-MM-DD HH:mm:ss")+" "+this.name+" (ERROR) : "+e;y&&t.error(n),S&&f(n)}},h.prototype.isERROR=function(){return m<=p.ERROR},h.prototype.isINFO=function(){return m<=p.INFO},h.prototype.isWARN=function(){return m<=p.WARN},h.prototype.isDEBUG=function(){return m<=p.DEBUG},h.prototype.levels=p;var D=new h("SYSTEM");return window.console.log=function(e){D.debug(e)},window.console.warn=function(e){D.warn(e)},window.console.error=function(e){D.error(e)},window.console.info=function(e){D.info(e)},window.console.exception=window.console.log,window.console.trace=window.console.log,window.console.group=window.console.log,window.console.groupCollapsed=window.console.log,window.console.table=function(e){console.log("%o",e)},d(),function(e){return void 0===g[e]&&(g[e]=new h(e)),g[e]}}])}(synthMobile),function(e){"use strict";e.factory("UserService",["$q","DataService","SynthFail",function(e,t){function n(){this.PROGRESS_AUTHENTICATE=0,this.PROGRESS_SELECT_MODULES=1,this.PROGRESS_COMPLETED=2}return n.prototype.getRegistrationProgress=function(){var e=this;return t.getRegistrationData().then(function(t){return null==t.username?e.PROGRESS_AUTHENTICATE:null==t.modules||null==t.defaultModule?e.PROGRESS_SELECT_MODULES:null!=t.defaultModule?e.PROGRESS_COMPLETED:n.PROGESS_AUTHENTICATE})},n.prototype.isRegistrationComplete=function(){var e=this;return e.getRegistrationProgress().then(function(t){return e.PROGRESS_COMPLETED==t})},new n}])}(synthMobile),function(e,t){"use strict";e.factory("DataService",["$q","$http","LoggerService","SynthError","UserSession","SynthConfig",function(e,n,o,r,i,a){function c(){this.deviceReady=!1,this.cachedRouteFileSystem=null}function s(e){return"string"==typeof e?JSON.parse(e):"object"==typeof e?e:(u.warn("Invalid object type : "+typeof e),null)}function l(e){return"string"==typeof e?(u.debug("Data type is string"),e):"object"==typeof e?(u.debug("Data type is object"),JSON.stringify(e)):(u.warn("Invalid object type : "+typeof e),null)}var u=o("DataService");return c.prototype.cordovaReady=function(){var t=e.defer();if(this.deviceReady===!0)t.resolve();else{var n=this;document.addEventListener("deviceready",function(){n.deviceReady=!0,t.resolve()},!1)}return t.promise},c.prototype.getApplicationRoot=function(){var t=e.defer(),n=this;return this.cordovaReady().then(function(){function e(e){e.root.getDirectory(a.dataDir,{create:!0,exclusive:!1},function(e){n.cachedRouteFileSystem=e,t.resolve(e)},function(e){u.warn("Failed to get application root : "+e),t.reject(r(1004,e.code))})}function o(e){u.warn("Failed to get filesystem, code:"+e.code),t.reject(r(1004,e.code))}window.requestFileSystem(LocalFileSystem.PERSISTENT,0,e,o)}),t.promise},c.prototype.checkAndCreateDirectory=function(t){var n=e.defer();return this.getApplicationRoot().then(function(e){function o(e){return e.length>0&&("."===e[0]||""===e[0])?(e=e.slice(1),o(e)):e}function i(e,a){if(a=o(a),0===a.length)return void n.resolve(e);var c=a[0];a=a.slice(1),e.getDirectory(c,{create:!0},function(e){a.length>0?i(e,a):n.resolve(e)},function(e){u.warn("Error creating path "+t+" : "+e),n.reject(r(1004,e))})}i(e,t?t.split("/"):[])}),n.promise},c.prototype.getLocalFilePath=function(){var t=e.defer();return this.getApplicationRoot().then(function(e){t.resolve(e.fullPath)},function(e){t.reject(r(1004,e))}),t.promise},c.prototype.writeToolData=function(t,n,o,i){var a=e.defer();return this.getDataDirectory(n,t).then(function(e){function t(e){e.onwriteend=function(){a.resolve()};var t=l(o);null!=t?e.write(t):(u.warn("Failed while trying to write tool data, Invalid data type given to write as tool data"),a.reject(r(1e3,"Invalid data type given to write as tool data")))}function c(e){u.warn("Failed while trying to write tool data, error : "+e),a.reject(r(1004))}var s=n+(i?".upload.json":".json");e.getFile(s,{create:!0,exclusive:!1},function(e){e.createWriter(t,c)},c)},function(){a.reject()}),a.promise},c.prototype.writeToFile=function(t,n,o){var i=e.defer();
return this.checkAndCreateDirectory(t).then(function(e){function t(e){e.onwriteend=function(){i.resolve()};var t=l(o);e.write(t)}function a(e){u.warn("Failed while trying to write to file, error: "+e),i.reject(r(1004))}e.getFile(n,{create:!0,exclusive:!1},function(e){e.createWriter(t,a)},a)},function(e){u.warn("Failed while trying to write to file, error: "+e),i.reject(r(1004))}),i.promise},c.prototype.copyFromWebToFile=function(t,n,o){function i(e){c.writeToFile(n,o,e).then(function(){a.resolve()},function(e){u.warn("Failed while trying to copy file from web, error: "+e),a.reject(r(1004))})}var a=e.defer(),c=this;return this.getWebData(t).then(function(e){i(e)},function(e){u.warn("Failed to get web data : "+e),a.reject(r(1004))}),a.promise},c.prototype.mergeToToolData=function(t,n,o,i){var a=e.defer(),c=this;return this.getToolData(t,n,i).then(function(e){var l=s(o),u=jQuery.extend(!0,e,l);c.writeToolData(t,n,u,i).then(function(){a.resolve()},function(){a.reject(r(1004))})},function(){}),a.promise},c.prototype.mergeToFile=function(t,n,o){var r=e.defer(),i=this;return this.getFileData(t,n).then(function(e){var a=jQuery.extend(!0,e,o);i.writeToFile(t,n,JSON.stringify(a)).then(function(){r.resolve()},function(e){r.reject(e)})},function(e){r.reject(e)}),r.promise},c.prototype.getToolDirectory=function(t,n){var o=e.defer(),r=t+("base"===n?"/base":"/tools/"+n);return this.checkAndCreateDirectory(r).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},c.prototype.getDataDirectory=function(t,n){var o=e.defer();null==n&&(n=i.activeModule);var r=n+("base"===t?"/base":"/tools/"+t);return this.checkAndCreateDirectory(r+"/data").then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},c.prototype.getFileInToolData=function(t,n,o){var i=e.defer();return this.getDataDirectory(n,t).then(function(e){e.getFile(o,{create:!1},function(e){var t=new FileReader;t.onloadend=function(e){u.debug(e.target.result),i.resolve(e.target.result)},e.file(function(e){t.readAsDataURL(e)},function(){u.warn("Failed to get file from file entry"),i.reject(r(1004))})},function(){u.warn("Fail while trying to get file in directory"),i.reject(r(1004))})},function(e){i.reject(e)}),i.promise},c.prototype.getWebData=function(t){return n({method:"GET",url:t}).then(function(e){return e.data},function(){return e.reject(r(1004))})},c.prototype.getFileData=function(t,n){u.debug("Getting data for: directroy="+t+", filename="+n);var o=e.defer(),i=this;return this.checkAndCreateDirectory(t).then(function(e){e.getFile(n,{create:!0},function(e){i.getFileAsObject(e).then(function(e){u.isDEBUG()&&u.debug("Got data :"+JSON.stringify(e)),o.resolve(e)},function(e){o.reject(e)})},function(){u.warn("Fail while trying to get file in directory"),o.reject(r(1004))})},function(e){o.reject(e)}),o.promise},c.prototype.getModuleData=function(e){return this.getFileData(e,"module.json")},c.prototype.getRegistrationData=function(){return this.getFileData("","registration.json")},c.prototype.getSettingsData=function(){return this.getFileData("","settings.json")},c.prototype.ensureSettingsData=function(){function t(){return c.getWebData("base/data/settings.json").then(function(e){a=e})}function n(){return c.getSettingsData().then(function(e){return i=e})}function o(){return i=jQuery.extend(!0,a,i),e.when(i)}function r(){return c.mergeToSettingsData(i)}var i,a,c=this;return t().then(n).then(o).then(r).then(n)},c.prototype.mergeToModuleData=function(e,t){return this.mergeToFile(e,"module.json",t)},c.prototype.mergeToRegistrationData=function(e){return this.mergeToFile("","registration.json",e)},c.prototype.mergeToSettingsData=function(e){return this.mergeToFile("","settings.json",e)},c.prototype.getMergedToolData=function(t,n){function o(){return s.getToolData(t,n,!0).then(function(e){a=e})}function r(){return s.getToolData(t,n,!1).then(function(e){c=e})}function i(){var t=jQuery.extend(!0,a,c);return e.when(t)}var a,c,s=this;return o().then(r).then(i)},c.prototype.getToolUploadDataSize=function(t,n){function o(e){r.reject(e)}var r=e.defer();return this.getDataDirectory(n,t).then(function(e){var t=n+".upload.json";e.getFile(t,{create:!0},function(e){e.file(function(e){r.resolve(e.size)},o)},o)},o),r.promise},c.prototype.deleteToolUploadData=function(t,n){var o=e.defer();return this.getToolDataFile(t,n,!0).then(function(e){e.remove(function(){o.resolve()},function(){u.warn("Error deleting upload file"),o.reject(r(1004,"Error deleting upload file"))})},function(e){o.reject(e)}),o.promise},c.prototype.getToolDataFile=function(t,n,o){var i=e.defer();return this.getDataDirectory(n,t).then(function(e){var t=n+(o?".upload.json":".json");e.getFile(t,{create:!0},function(e){i.resolve(e)},function(e){u.warn("Error getting tool data file, error: "+e),i.reject(r(1004))})},function(e){i.reject(e)}),i.promise},c.prototype.getToolData=function(t,n,o){function r(e){i.reject(e)}u.debug("Getting data for tool : "+t+" - "+n);var i=e.defer(),a=this;return this.getToolDataFile(t,n,o).then(function(e){a.getFileAsObject(e).then(function(e){i.resolve(e)},r)},r),i.promise},c.prototype.getFileContentCDV=function(t){var n=e.defer();return window.resolveLocalFileSystemURL(t,function(e){e.file(function(e){var t=new FileReader;t.onloadend=function(e){n.resolve(e.target.result)},t.readAsText(e)},function(){n.reject(r(1004))})},function(){n.reject(r(1004))}),n.promise},c.prototype.getFileContent=function(t,n,o){function a(){return s.getDataDirectory(t,n).then(function(e){l=e})}function c(){var t=e.defer();return u.debug("Getting content of file: "+l.nativeURL+"/"+o),l.getFile(o,null,function(e){e.file(function(e){var n=new FileReader;n.onloadend=function(e){t.resolve(e.target.result)},n.readAsText(e)},function(){t.reject(r(1004))})},function(){t.reject(r(1004))}),t.promise}var s=this,l=null;return null==n&&(n=i.activeModule),a().then(c)},c.prototype.getFileAsObject=function(n){function o(e){u.warn("Failed getting file as object, error : "+e),i.reject(r(1004,e))}var i=e.defer();return n.file(function(e){var n=new FileReader;n.onloadend=function(e){if(""===e.target.result)i.resolve({});else try{i.resolve(t.fromJson(e.target.result))}catch(n){u.warn("Failed to create object from json string : \n"+e.target.result),i.reject(r(1004))}},n.readAsText(e)},o),i.promise},c.prototype.doesFileExist=function(t){var n=e.defer();return this.getApplicationRoot().then(function(e){e.getFile(t,{create:!1},function(){n.resolve(!0)},function(){n.resolve(!1)})},function(e){n.reject(e)}),n.promise},c.prototype.deleteAllApplicationData=function(){var t=e.defer();return i.clearSession(),this.getApplicationRoot().then(function(e){e.removeRecursively(function(){t.resolve()},function(){t.reject(r(1004,"Error deleting all aplication data"))})},function(e){t.reject(e)}),t.promise},c.prototype.generateUID=function(){return"UNIPOOLE_xxxxxxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})},new c}])}(synthMobile,angular),function(e){"use strict";e.factory("SyncAPIService",["$q","$http","$filter","base64","DataService","UserSession","LoggerService","SynthError","SynthFail","SynthCheckResponseError","SynthConfig","AppSyncStatus","SynthQLoop",function(e,t,n,o,r,i,a,c,s,l,u,d,f){function h(){}function g(e){return u.toolMapping[e]||e}function p(e,t){var n=t[e];for(var o in n)n[g(o)]=n[o],delete n[o]}var m=a("SyncAPIService");return h.prototype.getSyncStatusOffline=function(t){var o=e.defer();null==t&&(t=i.activeModule);var a=s(o),c=this,l={},u={inSync:!0,tools:{}},h=function(n){m.debug("Checking offline sync status for toolId : "+n);var o=e.defer(),r=s(o),i=l.toolsLocal[n],a=l.tools[n];return null==a&&o.resolve(),u.tools[n]={codeDownloadSize:0,contentDownloadSize:0,contentUploadSize:0,inSync:!0,label:l.toolDescriptions[n].label},i.clientContentVersion!==a.currentContentVersion&&(u.tools[n].contentDownloadSize=a.contentSynchSize,u.tools[n].inSync=!1,u.inSync=!1),c.getToolUploadSize(t,n).then(function(e){0!==e&&(u.tools[n].contentUploadSize=e,u.tools[n].inSync=!1,u.inSync=!1),o.resolve(u)},r),o.promise};return r.getModuleData(t).then(function(e){if(l=e,null==l||null==l.tools)u.inSync=!1,o.resolve(u);else{var t=0,r=n("object2Array")(l.toolsLocal);f(function(){var e;return e=t>=r.length?null:h(r[t++].key)}).then(function(){d.inSync=u.inSync,d.tools=u.tools,o.resolve(u)})}},a),o.promise},h.prototype.getToolUploadSize=function(e,t){function n(n){var o={toolsLocal:{}};return o.toolsLocal[t]={localChange:0!==n,localChangeSize:n},r.mergeToFile(e,"module.json",o).then(function(){return n})}return r.getToolUploadDataSize(e,t).then(n)},h.prototype.getSyncStatus=function(o){function a(){return r.getModuleData(o).then(function(e){S=e})}function s(){var n=e.defer(),r={deviceId:i.deviceId,tools:{}};for(var a in S.toolsLocal){var s=g(a);r.tools[s]={clientCodeVersion:S.toolsLocal[a].clientCodeVersion,clientContentVersion:S.toolsLocal[a].clientContentVersion}}var d=u.baseURL+"/service-synch/synchStatus/"+i.username+"/"+o;return m.debug("Getting sync status calling REST URL : "+d),t({method:"POST",url:d,data:r}).success(function(e){l(n,e)||n.resolve(e.tools)}).error(function(){n.reject(c(1e3))}),n.promise}function h(e){var t={tools:{}};for(var n in e){var i=g(n);t.tools[i]={clientCodeVersion:e[n].clientCodeVersion,clientContentVersion:e[n].clientContentVersion,currentCodeVersion:e[n].currentCodeVersion,currentContentVersion:e[n].currentContentVersion,codeSynchSize:e[n].codeSynchSize,contentSynchSize:e[n].contentSynchSize},y.tools[i]={label:S.toolDescriptions[i].label,codeDownloadSize:0,contentDownloadSize:e[n].contentSynchSize,contentUploadSize:0,inSync:0===e[n].contentSynchSize},y.download=(y.download?y.download:0)+e[n].contentSynchSize,y.tools[i].inSync||(y.inSync=!1)}return r.mergeToModuleData(o,t)}function p(){if(null==D&&(D=n("object2Array")(y.tools)),w==D.length)return null;var e=D[w++].key;return y.tools[e]=y.tools[e]||{codeDownloadSize:0,contentDownloadSize:0,contentUploadSize:0,inSync:!0},y.tools[e].label=S.toolDescriptions[e].label,v.getToolUploadSize(o,e).then(function(t){y.tools[e].contentUploadSize=t,y.tools[e].inSync=y.tools[e].inSync&&0===t,y.upload=(y.upload?y.upload:0)+t,y.inSync=y.inSync&&y.tools[e].inSync})}var y={inSync:!0,tools:{}};null==o&&(o=i.activeModule);var S=null,v=this,w=0,D=null;return a().then(s).then(h).then(function(){return f(p)}).then(function(){return y.total=(y.download?y.download:0)+(y.upload?y.upload:0),d.inSync=y.inSync,d.tools=y.tools,y})},h.prototype.syncDownloadTool=function(n,a){function s(){return r.getModuleData(n).then(function(e){U=e})}function f(){var o=e.defer(),r=U.toolsLocal[a].clientContentVersion,s=g(a),d=u.baseURL+"/service-synch/contentUpdateString/"+i.username+"/"+i.deviceId+"/"+n+"/"+s+"/"+r;return t({method:"POST",url:d,data:{authToken:i.authToken}}).success(function(e){l(o,e)||(C=e,o.resolve(e))}).error(function(){o.reject(c(1e3))}),o.promise}function h(t){try{R=o.decode(t.content),m.debug("Got data for tool "+a+" : \n"+R),R=JSON.parse(R),e.when(R)}catch(n){e.reject(c(1e3))}}function y(){var t=SynthEmbeddedImageHandler.getHandler(a);return t?r.getToolDirectory(n,a).then(function(e){R=t(R,"cdvfile://localhost/persistent"+e.fullPath)}):e.when([])}function S(){var t=SynthLinkHandler.getHandler(a);return t&&(R=t(R)),e.when([])}function v(){var e=SynthAttachmentMiner.getHandler(a);return e?r.getDataDirectory(a,n).then(function(t){E=e(R,"cdvfile://localhost/persistent"+t.fullPath)}):$.when([])}function w(){return"base"==a?(p("toolDescriptions",R),r.mergeToModuleData(n,R)):r.mergeToToolData(n,a,R)}function D(){return T.getAttachementsFromServer(E)}function b(){var e={toolsLocal:{},tools:{}};return e.toolsLocal[a]={clientContentVersion:C.version},e.tools[a]={currentContentVersion:C.version,clientContentVersion:C.version,contentSynchSize:0},r.mergeToModuleData(n,e)}function M(t){return d.downloading=!1,e.reject(t)}var U=null,T=this,C={},R={},E=[];return d.downloading=!0,s().then(f).then(h).then(v).then(D).then(y).then(S).then(w).then(b).then(function(){d.downloading=!1},M)},h.prototype.syncUploadTool=function(n,o){function a(t){return d.uploading=!1,e.reject(t)}var s={},f={},h={};d.uploading=!0;var p=function(){return r.getRegistrationData().then(function(e){h=e})},m=function(){return r.getToolData(n,o,!0).then(function(e){s=e})},y=function(){var r=e.defer(),a=u.baseURL+"/service-synch/content/"+i.username+"/"+i.deviceId+"/"+n+"/"+g(o);return t({method:"PUT",url:a,data:{authToken:i.authToken,content:s}}).success(function(e){l(r,e)||(f=e.responseContent,r.resolve(f))}).error(function(){r.reject(c(1e3))}),r.promise},S=function(){return r.deleteToolUploadData(n,o)},v=function(){var e=SynthUploadResponseHandler.getHandler(o);return e&&(s=e(s,f)),r.mergeToToolData(n,o,s,!1)};return p().then(m).then(y).then(S).then(v).then(function(){d.uploading=!1},a)},h.prototype.getAllowedSites=function(){var n=u.baseURL+"/service-auth/allowedSites/"+i.username;return t({method:"GET",url:n,data:{authToken:i.authToken}}).then(function(t){var n=t.data;return l(null,n)?e.reject(c(n)):n.modules},function(){return e.reject(c(1e3))})},h.prototype.registerForModule=function(n){var o=e.defer();return r.getModuleData(n).then(function(e){var r={};for(var a in e.toolsLocal)r[g(a)]=e.toolsLocal[a];var s={deviceId:i.deviceId,moduleId:n,tools:r,authToken:i.authToken},d=u.baseURL+"/service-auth/register/"+i.username;m.debug("Registering user for module '"+n+"' using REST URL : "+d),m.isDEBUG()&&m.debug("Posting data : "+JSON.stringify(s)),t({method:"POST",url:d,data:s}).success(function(e){l(o,e)||o.resolve(e)}).error(function(){o.reject(c(1e3))})},s(o)),o.promise},h.prototype.updateModuleData=function(n){var o=e.defer(),i=u.baseURL+"/service-creator/clientData/"+n;return m.debug("Getting module data using REST URL : "+i),t({method:"GET",url:i}).success(function(e){m.isDEBUG()&&m.debug("Got response for module data : "+JSON.stringify(e,"	",4)),l(o,e)||r.getModuleData(n).then(function(t){m.isDEBUG()&&m.debug("Got current module data : "+JSON.stringify(t,"	",4));var i={toolDescriptions:{},tools:{}};for(var a in e.toolDescriptions)void 0!==t.toolDescriptions[g(a)]&&(i.toolDescriptions[g(a)]={},i.toolDescriptions[g(a)].label=e.toolDescriptions[a].label,i.toolDescriptions[g(a)].description=e.toolDescriptions[a].description,i.toolDescriptions[g(a)].menu=e.toolDescriptions[a].menu,i.toolDescriptions[g(a)].seq=e.toolDescriptions[a].seq);for(var a in e.tools)void 0!==t.toolDescriptions[g(a)]&&(i.tools[g(a)]=e.tools[a]);m.debug("We will now merge these : "+JSON.stringify(i,"	",4)),r.mergeToModuleData(n,i).then(function(){o.resolve()},s(o))},s(o))}).error(function(){m.warn("Failed to get module data from remote server"),o.reject(c(1e3))}),o.promise},h.prototype.getAttachementsFromServer=function(t){function n(){if(t.length===r)return null;var e=o.getFileFromServer(t[r].downloadKey,t[r].downloadPath);return r++,e}var o=this;if(!t||0===t.length)return m.info("No need to download any attachments, an empty array was given"),e.when({});var r=0;return f(n)},h.prototype.getFileFromServer=function(t,n){var o=e.defer(),r=new FileTransfer,i=encodeURI(u.baseURL+"/service-creator/download/file/"+t);return m.debug("Downloading file with URL "+i),r.onprogress=function(e){o.notify(e)},r.download(i,n,function(){m.debug("Download is complete"),o.resolve()},function(e){m.warn("Failed to download file!"),m.warn("download error source "+e.source),m.warn("download error target "+e.target),m.warn("upload error code"+e.code),o.reject(c(1004))},!1,{}),o.promise},h.prototype.authenticateUser=function(n,o){function a(){return t({method:"POST",url:d,data:f}).then(function(t){var n=t.data;return"1005"==n.errorCode?{authenticated:!1,message:n.message,errorCode:n.errorCode,instruction:n.instruction}:l(null,n)?e.reject(c(n)):{authenticated:!0,authToken:n.authToken}},function(){return e.reject(c(1e3))})}function s(t){if(t.authToken){var o={username:n,authToken:t.authToken};return i.updateSession(o),r.mergeToRegistrationData(o).then(function(){return e.when(t)})}return e.when(t)}var d=u.baseURL+"/service-auth/login/"+n;m.debug("Authenticating user with URL : "+d);var f={password:o};return a().then(s)},new h}])}(synthMobile),synthMobile.config(["$routeProvider",function(e){e.when("/tool/announcements",{templateUrl:"tools/announcements/partials/announcements-list.html"}).when("/tool/announcements/:announcementId",{templateUrl:"tools/announcements/partials/announcements-detail.html"})}]),SynthAttachmentMiner.addHandler("announcements","default"),SynthEmbeddedImageHandler.addHandler("announcements",function(e,t){for(var n in e)e[n].body=SynthEmbeddedImageHandler.fixForHtmlElement(e[n].body,t);return e}),SynthLinkHandler.addHandler("announcements",function(e){for(var t in e){var n=e[t].body;null!=n&&(e[t].body=SynthLinkHandler.fixContent(n))}return e}),synthMobile.factory("AnnouncementService",["$q","DataService","UserSession","SynthFail",function(e,t,n,o){function r(){}return r.prototype.getAnnouncements=function(){var r=e.defer();return t.getToolData(n.activeModule,"announcements").then(function(e){r.resolve(e)},o(r)),r.promise},r.prototype.getAnnouncement=function(r){var i=e.defer();return t.getToolData(n.activeModule,"announcements").then(function(e){i.resolve(e[r])},o(i)),i.promise},new r}]),synthMobile.controller("AnnouncementListCtrl",["$scope","$rootScope","AnnouncementService","SynthErrorHandler",function(e,t,n,o){t.activePage="announcements",t.breadcrumbs=[{name:"Announcements"}],n.getAnnouncements().then(function(t){e.announcements=t},o)}]).controller("AnnouncementDetailCtrl",["$scope","$rootScope","$routeParams","AnnouncementService","DataService","UserSession","SynthErrorHandler",function(e,t,n,o,r,i,a){t.activePage="announcements",t.breadcrumbs=[{name:"Announcements",url:"#/tool/announcements"}],o.getAnnouncement(n.announcementId).then(function(n){e.announcement=n,t.breadcrumbs=[{name:"Announcements",url:"#/tool/announcements"}]},a)}]),synthMobile.factory("FaqService",["$q","DataService","UserSession","LoggerService",function(e,t,n,o){function r(){}o("FaqService");return r.prototype.getFaqs=function(){return t.getToolData(n.activeModule,"faq")},r.prototype.getFaq=function(e){return t.getToolData(n.activeModule,"faq").then(function(t){return t[e]})},new r}]),$(document).ready(function(){$(".tree-toggle").click(function(){$(this).parent().children("ul.tree").toggle(200)})}),synthMobile.controller("FaqListCtrl",["$scope","$rootScope","FaqService","SynthErrorHandler",function(e,t,n,o){function r(e){var t=[];for(var n in e)e[n].isParent=e[n].id===e[n].parentId,e[n].isParent&&(t.push(e[n]),i(e[n],e));return t}function i(e,t){for(var n in t)t[n].parentId===e.id&&t[n].id!==e.id&&(e.children=e.children||[],e.children.push(t[n]))}t.activePage="faqs",t.breadcrumbs=[{name:"FAQs"}],n.getFaqs().then(function(t){e.faqs=r(t)},o)}]).controller("FaqDetailCtrl",["$scope","$rootScope","$routeParams","FaqService","SynthErrorHandler",function(e,t,n,o,r){t.activePage="faqs",t.breadcrumbs=[{name:"FAQs",url:"#/tool/faq"}],o.getFaq(n.faqId).then(function(n){o.getFaq(n.parentId).then(function(o){n.category=o.description,t.breadcrumbs=[{name:"FAQs",url:"#/tool/faq"},{name:n.category}],e.faq=n},r)},r)}]),synthMobile.config(["$routeProvider",function(e){e.when("/tool/faq",{templateUrl:"tools/faq/partials/faq-list.html"}).when("/tool/faq/:faqId",{templateUrl:"tools/faq/partials/faq-detail.html"})}]),synthMobile.config(["$routeProvider",function(e){e.when("/tool/welcome",{templateUrl:"tools/welcome/partials/welcome.html",controller:"WelcomeCtrl"})}]),SynthAttachmentMiner.addHandler("welcome","default"),SynthEmbeddedImageHandler.addHandler("welcome",function(e,t){return e.content=SynthEmbeddedImageHandler.fixForHtmlElement(e.content,t),e}),synthMobile.factory("WelcomeService",["$q","DataService","UserSession","LoggerService",function(e,t,n,o){function r(){}var i=o("WelcomeService");return r.prototype.getWelcome=function(){var o=e.defer();return t.getToolData(n.activeModule,"welcome").then(function(e){o.resolve(e)},function(){i.warn("Service failed to get welcome"),o.reject()}),o.promise},new r}]),synthMobile.controller("WelcomeCtrl",["$scope","$q","WelcomeService","UserSession",function(e,t,n){n.getWelcome().then(function(t){e.welcome=t},function(){console.log("Failed to get welcome")})}]),synthMobile.config(["$routeProvider",function(e){e.when("/tool/forums",{templateUrl:"tools/forums/partials/forums-list.html"}).when("/tool/forums/:forumId",{templateUrl:"tools/forums/partials/discussions-list.html"}).when("/tool/forums/:forumId/:discussionId",{templateUrl:"tools/forums/partials/discussion.html"}).when("/tool/forums/:forumId/:discussionId/reply",{templateUrl:"tools/forums/partials/reply.html"}).when("/tool/forums/:forumId/:discussionId/:messageId/reply",{templateUrl:"tools/forums/partials/reply.html"})}]),SynthAttachmentMiner.addHandler("forums",function(e,t){var n=[];for(var o in e){var r=e[o],i=r.discussions;for(var a in i){var c=i[a];n=n.concat(SynthAttachmentMiner.parseArray(c.attachments,t));var s=c.messages;for(var l in s){var u=s[l];n=n.concat(SynthAttachmentMiner.parseArray(u.attachments,t))}}}return n}),SynthEmbeddedImageHandler.addHandler("forums",function(e,t){for(var n in e){var o=e[n],r=o.discussions;for(var i in r){var a=r[i];a.content=SynthEmbeddedImageHandler.fixForHtmlElement(a.content,t);var c=a.messages;for(var s in c){var l=c[s];l.content=SynthEmbeddedImageHandler.fixForHtmlElement(l.content,t)}}}return e}),SynthUploadResponseHandler.addHandler("forums",function(e,t){var n=JSON.stringify(e);for(var o in t){var r=t[o],i=new RegExp(o,"g");n=n.replace(i,r)}return n}),SynthLinkHandler.addHandler("forums",function(e){for(var t in e){var n=e[t],o=n.discussions;for(var r in o){var i=o[r];i.content=SynthLinkHandler.fixContent(i.content);var a=i.messages;for(var c in a){var s=a[c];s.content=SynthLinkHandler.fixContent(s.content)}}}return e}),synthMobile.factory("ForumService",["$q","DataService","UserSession","LoggerService",function(e,t,n,o){function r(){}o("ForumService");return r.prototype._getData=function(){return t.getMergedToolData(n.activeModule,"forums")},r.prototype.getForums=function(){return this._getData()},r.prototype.getForum=function(e){return this._getData().then(function(t){return t[e]})},r.prototype.getDiscussion=function(e,t){return this.getForum(e).then(function(e){return e.discussions[t]})},r.prototype.getMessage=function(e,t,n){return this.getDiscussion(e,t).then(function(e){return e.messages[n]})},r.prototype.replyOnMessage=function(o,r,i){function a(e){var a={},s=moment().toISOString(),l=t.generateUID(),u={id:l,topic:i.topic,content:i.message,depth:e.depth+1,url:null,parent:e.id,status:"READY",attachments:null,create_date:s,creator_name:n.username,creator_id:n.lms_id,discussion_id:r,group_size:0,site_id:n.activeModule,attachment_count:0,reply_count:0};a[o]={},a[o].discussions={},a[o].discussions[r]={},a[o].discussions[r].messages={},a[o].discussions[r].messages[l]=u,t.mergeToToolData(n.activeModule,"forums",a,!0).then(function(){c.resolve()},function(e){c.reject(e)})}var c=e.defer(),s=this;return i.messsageId?s.getMessage(o,r,i.messsageId).then(function(e){a(e)},function(e){c.reject(e)}):s.getDiscussion(o,r).then(function(e){a(e)},function(e){c.reject(e)}),c.promise},new r}]),synthMobile.controller("ForumListCtrl",["$scope","$rootScope","$window","ForumService","SynthErrorHandler",function(e,t,n,o,r){t.activePage="forums",t.breadcrumbs=[{name:"Discussions"}],e.props=n.synth.utilities.getNumberOfProperties,o.getForums().then(function(t){e.forums=t},r)}]).controller("DiscussionListCtrl",["$scope","$rootScope","$window","$routeParams","ForumService","SynthErrorHandler",function(e,t,n,o,r,i){t.activePage="forums",e.props=n.synth.utilities.getNumberOfProperties,r.getForum(o.forumId).then(function(n){t.breadcrumbs=[{name:"Discussions",url:"#/tool/forums"},{name:n.title}],e.forum=n},i)}]).controller("DiscussionCtrl",["$scope","$rootScope","$window","$routeParams","ForumService","SynthErrorHandler",function(e,t,n,o,r,i){t.activePage="forums",e.reply=function(e){n.location=e?n.location+"/"+e+"/reply":n.location+"/reply"},r.getDiscussion(o.forumId,o.discussionId).then(function(n){e.discussion=n,r.getForum(o.forumId).then(function(e){t.breadcrumbs=[{name:"Discussions",url:"#/tool/forums"},{name:e.title,url:"#/tool/forums/"+o.forumId}]},i)},i)}]).controller("ReplyCtrl",["$scope","$rootScope","$window","$routeParams","ForumService","SynthErrorHandler","SyncService",function(e,t,n,o,r,i,a){function c(t){e.topic=t.indexOf("Re:")<0?"Re: "+t:t}t.activePage="forums";var s=void 0!==o.messageId;s?r.getMessage(o.forumId,o.discussionId,o.messageId).then(function(n){e.replyMessage=n,c(n.topic),e.discussion=discussion,t.breadcrumbs=[{name:"Discussions",url:"#/tool/forums"},{name:"Reply"}]},i):r.getDiscussion(o.forumId,o.discussionId).then(function(t){e.replyMessage=t,c(t.topic)},i),e.submit=function(){var t=(e.message,{topic:e.topic,message:e.message,messageId:o.messageId});r.replyOnMessage(o.forumId,o.discussionId,t).then(function(){a.notifyChanges("forums"),n.location="#/tool/forums/"+o.forumId+"/"+o.discussionId},i)}}]),synthMobile.config(["$routeProvider",function(e){e.when("/tool/schedule",{templateUrl:"tools/schedule/partials/schedule.html"})}]),SynthAttachmentMiner.addHandler("schedule","default"),SynthLinkHandler.addHandler("schedule",function(e){for(var t in e){var n=e[t].description;null!=n&&(e[t].description=SynthLinkHandler.fixContent(n))}return e}),synthMobile.factory("ScheduleService",["$q","$filter","DataService","UserSession","SynthFail",function(e,t,n,o){function r(){}function i(e){var t=[];for(var n in e)a(t,e[n]);for(var o=0;o<t.length;o++)e[t[o].id]=t[o]}function a(e,t){switch(t.frequency){case"day":c(e,t,"days",1);break;case"MWF":c(e,t,"days",1,[1,3,5]);break;case"TT":c(e,t,"days",1,[2,4]);break;case"week":c(e,t,"weeks",1);break;case"month":c(e,t,"months",1);break;case"year":c(e,t,"years",1)}}function c(e,t,n,o,r){if(t.recurs_until)for(var i=moment(t.recurs_until),a=1;i.isAfter(moment(t.start).add(n,a*o));){var c=moment(t.start).add(n,a*o);if(!r||jQuery.inArray(c.day(),r)>-1){var s={};jQuery.extend(s,t),s.start=c.toDate(),s.end=moment(t.end).add(n,a*o).toDate(),s.id=t.id+"_"+a++,e.push(s)}}else for(var l=1,u=0;l<t.recurrence_count;u++){var d=moment(t.start).add(n,(u+1)*o);if(!r||jQuery.inArray(d.day(),r)>-1){var s={};jQuery.extend(s,t),s.start=d.toDate(),s.end=moment(t.end).add(n,(u+1)*o).toDate(),s.id=t.id+"_"+u,e.push(s),l++}}}return r.prototype.getAll=function(){return n.getToolData(o.activeModule,"schedule").then(function(e){return i(e),e})},r.prototype.getEvent=function(e){return this.getAll().then(function(t){return t[e]})},new r}]),synthMobile.controller("ScheduleCtrl",["$scope","$rootScope","$filter","$timeout","ScheduleService","SynthErrorHandler",function(e,t,n,o,r,i){function a(e,t){var n=[];for(var o in c){var r=c[o];null===r.end&&(r.end=r.start+1),e.isBefore(r.start)&&t.isAfter(r.end)&&n.push(r)}return n}t.activePage="schedule",t.breadcrumbs=[{name:"Schedule"}],e.filterOption="today";var c=[];e.startCalendar=new Date,e.endCalendar=new Date,e.loadingSchedule=!0,e.orderDateFunc=function(e){return moment(e.start).valueOf()},e.open=function(t,n){t.preventDefault(),t.stopPropagation(),"start"===n?(e.startCalendarOpen=!0,e.endCalendarOpen=!1):(e.endCalendarOpen=!0,e.startCalendarOpen=!1)},e.changedFilterOption=function(){e.loadingSchedule=!0,o(function(){var t=e.filterOption,n=moment(),o=moment();if("all"===t)return e.schedule=c,void(e.loadingSchedule=!1);if("startEnd"===t){if(void 0===e.startCalendar||""===e.startCalendar)return e.schedule=[],void(e.loadingSchedule=!1);n=moment(e.startCalendar),o=void 0===e.endCalendar||""===e.endCalendar?moment(n).add("years",50):moment(e.endCalendar)}else if("today"===t)n=moment().startOf("day"),o=moment().endOf("day");else if("week"===t)n=moment().startOf("week"),o=moment().endOf("week");else if("month"===t)n=moment().startOf("month"),o=moment().endOf("month");else if("year"===t)n=moment().startOf("year"),o=moment().endOf("year");else if("specific"===t){var r=[];if(void 0!==e.specificYear&&""!==e.specificYear){if(e.specificMonthDisabled=!1,n=moment(e.specificYear,"YYYY"),void 0!==e.specificMonth&&""!==e.specificMonth){e.specificDayDisabled=!1,n=moment(e.specificYear+"-"+e.specificMonth,"YYYY-M");var i=moment(e.specificYear+"-"+e.specificMonth).daysInMonth();void 0!==e.specificDay&&""!==e.specificDay&&(e.specificDay>i&&(e.specificDay=1),n=moment(e.specificYear+"-"+e.specificMonth+"-"+e.specificDay,"YYYY-M-D"));for(var s=1;i>=s;s++)r.push(s);e.days=r}o=moment(n).add("years",50)}else e.specificMonthDisabled=!0,e.specificDayDisabled=!0;e.days=r}e.loadingSchedule=!1,e.schedule=a(n,o)},500)},r.getAll().then(function(t){c=n("object2Array")(t),e.changedFilterOption()},i)}]),synthMobile.config(["$routeProvider",function(e){e.when("/tool/learning_units",{templateUrl:"tools/learning_units/partials/unit-list.html"}).when("/tool/learning_units/:unitId",{templateUrl:"tools/learning_units/partials/viewUnit.html"}).when("/tool/learning_units/:unitId/:sectionId",{templateUrl:"tools/learning_units/partials/viewSection.html"})}]),SynthEmbeddedImageHandler.addHandler("learning_units",function(e,t){function n(e){var t=$("<div/>").html(e);return t.find("img").each(function(){var e=$(this).attr("src"),t=e;t=t.replace(o,"/data/"),t=t.replace(r,"/images/"),$(this).attr("data-src",i+t),$(this).attr("src","#");var n=e;n=n.replace(o,"/group/"),n=n.replace(r,"/images/"),$(this).attr("data-resource-id",n)}),t.html()}var o=new RegExp("/access/meleteDocs/content/private/meleteDocs/","g"),r=new RegExp("/uploads/","g"),i=t.replace("learning_units","resources");for(var a in e){var c=e[a].content;null!=c&&(e[a].content=n(c)),c=e[a].description,null!=c&&(e[a].description=n(c))}return e}),SynthLinkHandler.addHandler("learning_units",function(e){for(var t in e){var n=e[t].content;null!=n&&(e[t].content=SynthLinkHandler.fixContent(n)),n=e[t].description,null!=n&&(e[t].description=SynthLinkHandler.fixContent(n))}return e}),synthMobile.factory("LearningUnitsService",["$q","filterFilter","DataService","UserSession","LoggerService",function(e,t,n,o,r){function i(){}r("LearningUnitsService");return i.prototype._getData=function(){return n.getMergedToolData(o.activeModule,"learning_units")},i.prototype.getUnits=function(){return this.getSectionsForParent(null)},i.prototype.getSectionsForParent=function(e,t){function n(e,o){for(var i in e)if(e[i].tt_parent_id==o){var a=e[i];r.push(a),t&&n(e,a.tt_id)}}var o=this,r=new Array;return o._getData().then(function(t){return n(t,e),r})},i.prototype.getSection=function(e){return this._getData().then(function(t){return t[e]})},i.prototype.getSections=function(e,t){function n(e){return o.getSectionsForParent(e.tt_id,t)}var o=this;return this.getSection(e).then(n)},new i}]),synthMobile.controller("LearningUnitsListCtrl",["$scope","$rootScope","$filter","$window","LearningUnitsService","SynthErrorHandler",function(e,t,n,o,r,i){t.activePage="learning_units",t.breadcrumbs=[{name:"Learning Units"}],r.getUnits().then(function(t){e.units=t},i)}]).controller("LearningUnitsViewUnitCtrl",["$scope","$rootScope","$routeParams","LearningUnitsService","SynthErrorHandler",function(e,t,n,o,r){t.activePage="learning_units",t.breadcrumbs=[{name:"Learning Units",url:"#/tool/learning_units"}],e.unitId=n.unitId,o.getSection(n.unitId).then(function(n){e.unit=n,t.breadcrumbs=[{name:"Learning Units",url:"#/tool/learning_units"},{name:n.title}]},r),o.getSections(n.unitId,!0).then(function(t){e.sections=t},r)}]).controller("LearningUnitsViewSectionCtrl",["$scope","$q","$compile","$rootScope","$routeParams","SynthQLoop","LearningUnitsService","ResourcesService","SynthErrorHandler",function(e,t,n,o,r,i,a,c,s){function l(t){for(var n=0;n<t.length;n++)if(t[n].id==e.sectionId){e.section=t[n],n+1<t.length&&(e.nextSection=t[n+1]),n-1>=0&&(e.previousSection=t[n-1]);break}}function u(t){var o=angular.element("<div>");
o.append(t.content),o.find("[data-resource-id]").each(function(){var t=$(this),o=angular.element("<resource-img />");o.attr("data-resource-id",t.attr("data-resource-id")),o.attr("data-src",t.attr("data-src")),o.attr("data-width",t.attr("width")),o.attr("data-height",t.attr("height"));var r=n(o)(e);t.replaceWith(r)}),$("#sectionContent").replaceWith(o)}o.activePage="learning_units",e.sectionId=r.sectionId,e.unitId=r.unitId,a.getSections(r.unitId,!0).then(function(e){l(e)},s),a.getSection(e.unitId).then(function(t){o.breadcrumbs=[{name:"Learning Units",url:"#/tool/learning_units"},{name:t.title,url:"#/tool/learning_units/"+e.unitId}]},s),a.getSection(r.sectionId).then(function(e){u(e)},s)}]),synthMobile.config(["$routeProvider",function(e){e.when("/tool/resources",{templateUrl:"tools/resources/partials/resources.html"})}]).directive("resourceImg",["ResourcesService",function(e){return{restrict:"E",templateUrl:"tools/resources/partials/resourceImg.html",scope:{},link:function(t,n,o){t.src=o.src,t.width=o.width,t.height=o.height,t.initialising=!0;var r={};e.getItem(o.resourceId).then(function(e){t.resource=r=e,t.initialising=!1}),t.download=function(){r.busyDownloading||(r.busyDownloading=!0,e.downloadResource(r).then(function(){r.busyDownloading=!1,r.isDownloaded=!0},function(e){r.busyDownloading=!1,console.log(e)},function(e){e instanceof ProgressEvent&&(r.downloadProgress=e.lengthComputable?e.loaded/e.total*100:e.loaded/r.size*100)}))}}}}]),SynthAttachmentMiner.addHandler("resources-removed",function(e,t){var n=[];for(var o in e){var r=e[o];if(0==r.directory&&null!=r.downloadKey){var i=r.treeId;i=i.replace(/[|&:;$%@"<>()+,]/g,"_"),i=encodeURI(t+i),n.push({downloadKey:r.downloadKey,downloadPath:i})}}return n}),synthMobile.factory("ResourcesService",["$q","DataService","UserSession","SyncAPIService","LoggerService",function(e,t,n,o,r){function i(){}r("ResourcesService");return i.prototype._getData=function(){return t.getMergedToolData(n.activeModule,"resources")},i.prototype.getItem=function(e){return this._getData().then(function(t){return t[e]})},i.prototype.getDirectChildren=function(e){function t(){var t=e;return null==t&&(t="/group/"+n.activeModule+"/"),r.getItem(t)}function o(e){return r._getData().then(function(t){var n=e.treeId,o=[];for(var r in t){var i=t[r];i.treeParentId===n&&o.push(i)}return o})}var r=this;return t().then(o)},i.prototype.downloadResource=function(e){function r(){return t.getDataDirectory("resources").then(function(t){var n=e.treeId;n=n.replace(/[|&:;$%@"<>()+,]/g,"_"),n=encodeURI("cdvfile://localhost/persistent"+t.fullPath+n),c={downloadKey:e.downloadKey,downloadPath:n}})}function i(){return o.getFileFromServer(c.downloadKey,c.downloadPath)}function a(){var o={};return o[e.id]={isDownloaded:!0,downloadPath:c.downloadPath},t.mergeToToolData(n.activeModule,"resources",o,!1).then(function(){return o[e.id]})}var c;return r().then(i).then(a)},new i}]),synthMobile.controller("ResourcesCtrl",["$scope","$filter","$rootScope","$window","$timeout","ResourcesService","DataService","SynthErrorHandler",function(e,t,n,o,r,i,a,c){function s(t){e.loadingResources=!0,r(function(){i.getDirectChildren(t).then(function(t){var n=t.sort(function(e,t){return e.directory&&t.directory||!e.directory&&!t.directory?e.name<t.name?-1:e.name>t.name?1:0:e.directory&&!t.directory?-1:1});e.loadingResources=!1,e.resources=n})},500)}function l(e){s(null==e.state?null:e.state.id)}n.activePage="forums",n.breadcrumbs=[{name:"Resources"}],e.showResourceInfo=!1,e.loadingResources=!0,e.parentResource=null;var u=null;a.getDataDirectory("resources").then(function(e){u=e.nativeURL}),e.goUp=function(){window.history.back()},e.showInfo=function(t,n){n.stopPropagation(),e.resourceInfo=t,e.myScroll.mainScroll.scrollTo(0,0),e.showResourceInfo=!0},e.hideInfo=function(){e.myScroll.mainScroll.scrollTo(0,0),e.showResourceInfo=!1},e.openResource=function(e){if(e.directory)history.pushState(e,"Resources","#/tool/resources"),s(e.id);else if(e.isDownloaded){var t=function(t){window.plugins.fileOpener.open({path:t,mimeType:e.mime_type},function(){},function(e){alert(e)})};"text/url"==e.mime_type?a.getFileContentCDV(e.downloadPath).then(function(e){t(e)},c):t(u+e.treeId)}},e.downloadResource=function(e,t){t&&t.stopPropagation(),e.busyDownloading=!0,i.downloadResource(e).then(function(t){e.busyDownloading=!1,e.isDownloaded=t.isDownloaded,e.downloadPath=t.downloadPath},function(t){e.busyDownloading=!1,console.log(t)},function(t){t instanceof ProgressEvent&&(e.downloadProgress=t.lengthComputable?t.loaded/t.total*100:t.loaded/e.size*100)})},window.addEventListener("popstate",l),e.$on("$destroy",function(){window.removeEventListener("popstate",l)}),s(null)}]);