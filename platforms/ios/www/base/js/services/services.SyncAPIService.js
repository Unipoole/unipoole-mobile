"use strict";synthMobile.factory("SyncAPIService",["$q","$http","$filter","base64","DataService","UserSession","LoggerService","SynthError","SynthFail","SynthCheckResponseError","SynthConfig","AppSyncStatus","SynthQLoop",function(e,n,o,t,r,i,a,l,c,s,u,d,f){function h(){}function S(e){return u.toolMapping[e]||e}function g(e,n){var o=n[e];for(var t in o)o[S(t)]=o[t],delete o[t]}var p=a("SyncAPIService");return h.prototype.getSyncStatusOffline=function(n){var t=e.defer();null==n&&(n=i.activeModule);var a=c(t),l=this,s={},u={inSync:!0,tools:{}},h=function(o){p.debug("Checking offline sync status for toolId : "+o);var t=e.defer(),r=c(t),i=s.toolsLocal[o],a=s.tools[o];return null==a&&t.resolve(),u.tools[o]={codeDownloadSize:0,contentDownloadSize:0,contentUploadSize:0,inSync:!0,label:s.toolDescriptions[o].label},i.clientContentVersion!==a.currentContentVersion&&(u.tools[o].contentDownloadSize=a.contentSynchSize,u.tools[o].inSync=!1,u.inSync=!1),l.getToolUploadSize(n,o).then(function(e){0!==e&&(u.tools[o].contentUploadSize=e,u.tools[o].inSync=!1,u.inSync=!1),t.resolve(u)},r),t.promise};return r.getModuleData(n).then(function(e){if(s=e,null==s||null==s.tools)u.inSync=!1,t.resolve(u);else{var n=0,r=o("object2Array")(s.toolsLocal);f(function(){var e;return e=n>=r.length?null:h(r[n++].key)}).then(function(){d.inSync=u.inSync,d.tools=u.tools,t.resolve(u)})}},a),t.promise},h.prototype.getToolUploadSize=function(e,n){function o(o){var t={toolsLocal:{}};return t.toolsLocal[n]={localChange:0!==o,localChangeSize:o},r.mergeToFile(e,"module.json",t).then(function(){return o})}return r.getToolUploadDataSize(e,n).then(o)},h.prototype.getSyncStatus=function(t){function a(){return r.getModuleData(t).then(function(e){y=e})}function c(){var o=e.defer(),r={deviceId:i.deviceId,tools:{}};for(var a in y.toolsLocal){var c=S(a);r.tools[c]={clientCodeVersion:y.toolsLocal[a].clientCodeVersion,clientContentVersion:y.toolsLocal[a].clientContentVersion}}var d=u.baseURL+"/service-synch/synchStatus/"+i.username+"/"+t;return p.debug("Getting sync status calling REST URL : "+d),n({method:"POST",url:d,data:r}).success(function(e){s(o,e)||o.resolve(e.tools)}).error(function(){o.reject(l(1e3))}),o.promise}function h(e){var n={tools:{}};for(var o in e){var i=S(o);n.tools[i]={clientCodeVersion:e[o].clientCodeVersion,clientContentVersion:e[o].clientContentVersion,currentCodeVersion:e[o].currentCodeVersion,currentContentVersion:e[o].currentContentVersion,codeSynchSize:e[o].codeSynchSize,contentSynchSize:e[o].contentSynchSize},v.tools[i]={label:y.toolDescriptions[i].label,codeDownloadSize:0,contentDownloadSize:e[o].contentSynchSize,contentUploadSize:0,inSync:0===e[o].contentSynchSize},v.download=(v.download?v.download:0)+e[o].contentSynchSize,v.tools[i].inSync||(v.inSync=!1)}return r.mergeToModuleData(t,n)}function g(){if(null==w&&(w=o("object2Array")(v.tools)),D==w.length)return null;var e=w[D++].key;return v.tools[e]=v.tools[e]||{codeDownloadSize:0,contentDownloadSize:0,contentUploadSize:0,inSync:!0},v.tools[e].label=y.toolDescriptions[e].label,m.getToolUploadSize(t,e).then(function(n){v.tools[e].contentUploadSize=n,v.tools[e].inSync=v.tools[e].inSync&&0===n,v.upload=(v.upload?v.upload:0)+n,v.inSync=v.inSync&&v.tools[e].inSync})}var v={inSync:!0,tools:{}};null==t&&(t=i.activeModule);var y=null,m=this,D=0,w=null;return a().then(c).then(h).then(function(){return f(g)}).then(function(){return v.total=(v.download?v.download:0)+(v.upload?v.upload:0),d.inSync=v.inSync,d.tools=v.tools,v})},h.prototype.syncDownloadTool=function(o,a){function c(){return r.getModuleData(o).then(function(e){U=e})}function f(){var t=e.defer(),r=U.toolsLocal[a].clientContentVersion,c=S(a),d=u.baseURL+"/service-synch/contentUpdateString/"+i.username+"/"+i.deviceId+"/"+o+"/"+c+"/"+r;return n({method:"POST",url:d,data:{authToken:i.authToken}}).success(function(e){s(t,e)||(C=e,t.resolve(e))}).error(function(){t.reject(l(1e3))}),t.promise}function h(n){try{z=t.decode(n.content),p.debug("Got data for tool "+a+" : \n"+z),z=JSON.parse(z),e.when(z)}catch(o){e.reject(l(1e3))}}function v(){var n=SynthEmbeddedImageHandler.getHandler(a);return n?r.getToolDirectory(o,a).then(function(e){z=n(z,"cdvfile://localhost/persistent"+e.fullPath)}):e.when([])}function y(){var n=SynthLinkHandler.getHandler(a);return n&&(z=n(z)),e.when([])}function m(){var e=SynthAttachmentMiner.getHandler(a);return e?r.getDataDirectory(a,o).then(function(n){R=e(z,"cdvfile://localhost/persistent"+n.fullPath)}):$.when([])}function D(){return"base"==a?(g("toolDescriptions",z),r.mergeToModuleData(o,z)):r.mergeToToolData(o,a,z)}function w(){return L.getAttachementsFromServer(R)}function T(){var e={toolsLocal:{},tools:{}};return e.toolsLocal[a]={clientContentVersion:C.version},e.tools[a]={currentContentVersion:C.version,clientContentVersion:C.version,contentSynchSize:0},r.mergeToModuleData(o,e)}function b(n){return d.downloading=!1,e.reject(n)}var U=null,L=this,C={},z={},R=[];return d.downloading=!0,c().then(f).then(h).then(m).then(w).then(v).then(y).then(D).then(T).then(function(){d.downloading=!1},b)},h.prototype.syncUploadTool=function(o,t){function a(n){return d.uploading=!1,e.reject(n)}var c={},f={},h={};d.uploading=!0;var g=function(){return r.getRegistrationData().then(function(e){h=e})},p=function(){return r.getToolData(o,t,!0).then(function(e){c=e})},v=function(){var r=e.defer(),a=u.baseURL+"/service-synch/content/"+i.username+"/"+i.deviceId+"/"+o+"/"+S(t);return n({method:"PUT",url:a,data:{authToken:i.authToken,content:c}}).success(function(e){s(r,e)||(f=e.responseContent,r.resolve(f))}).error(function(){r.reject(l(1e3))}),r.promise},y=function(){return r.deleteToolUploadData(o,t)},m=function(){var e=SynthUploadResponseHandler.getHandler(t);return e&&(c=e(c,f)),r.mergeToToolData(o,t,c,!1)};return g().then(p).then(v).then(y).then(m).then(function(){d.uploading=!1},a)},h.prototype.getAllowedSites=function(){var o=u.baseURL+"/service-auth/allowedSites/"+i.username;return n({method:"GET",url:o,data:{authToken:i.authToken}}).then(function(n){var o=n.data;return s(null,o)?e.reject(l(o)):o.modules},function(){return e.reject(l(1e3))})},h.prototype.registerForModule=function(o){var t=e.defer();return r.getModuleData(o).then(function(e){var r={};for(var a in e.toolsLocal)r[S(a)]=e.toolsLocal[a];var c={deviceId:i.deviceId,moduleId:o,tools:r,authToken:i.authToken},d=u.baseURL+"/service-auth/register/"+i.username;p.debug("Registering user for module '"+o+"' using REST URL : "+d),p.isDEBUG()&&p.debug("Posting data : "+JSON.stringify(c)),n({method:"POST",url:d,data:c}).success(function(e){s(t,e)||t.resolve(e)}).error(function(){t.reject(l(1e3))})},c(t)),t.promise},h.prototype.updateModuleData=function(o){var t=e.defer(),i=u.baseURL+"/service-creator/clientData/"+o;return p.debug("Getting module data using REST URL : "+i),n({method:"GET",url:i}).success(function(e){p.isDEBUG()&&p.debug("Got response for module data : "+JSON.stringify(e,"	",4)),s(t,e)||r.getModuleData(o).then(function(n){p.isDEBUG()&&p.debug("Got current module data : "+JSON.stringify(n,"	",4));var i={toolDescriptions:{},tools:{}};for(var a in e.toolDescriptions)void 0!==n.toolDescriptions[S(a)]&&(i.toolDescriptions[S(a)]={},i.toolDescriptions[S(a)].label=e.toolDescriptions[a].label,i.toolDescriptions[S(a)].description=e.toolDescriptions[a].description,i.toolDescriptions[S(a)].menu=e.toolDescriptions[a].menu,i.toolDescriptions[S(a)].seq=e.toolDescriptions[a].seq);for(var a in e.tools)void 0!==n.toolDescriptions[S(a)]&&(i.tools[S(a)]=e.tools[a]);p.debug("We will now merge these : "+JSON.stringify(i,"	",4)),r.mergeToModuleData(o,i).then(function(){t.resolve()},c(t))},c(t))}).error(function(){p.warn("Failed to get module data from remote server"),t.reject(l(1e3))}),t.promise},h.prototype.getAttachementsFromServer=function(n){function o(){if(n.length===r)return null;var e=t.getFileFromServer(n[r].downloadKey,n[r].downloadPath);return r++,e}var t=this;if(!n||0===n.length)return p.info("No need to download any attachments, an empty array was given"),e.when({});var r=0;return f(o)},h.prototype.getFileFromServer=function(n,o){var t=e.defer(),r=new FileTransfer,i=encodeURI(u.baseURL+"/service-creator/download/file/"+n);return p.debug("Downloading file with URL "+i),r.onprogress=function(e){t.notify(e)},r.download(i,o,function(){p.debug("Download is complete"),t.resolve()},function(e){p.warn("Failed to download file!"),p.warn("download error source "+e.source),p.warn("download error target "+e.target),p.warn("upload error code"+e.code),t.reject(l(1004))},!1,{}),t.promise},h.prototype.authenticateUser=function(o,t){function a(){return n({method:"POST",url:d,data:f}).then(function(n){var o=n.data;return"1005"==o.errorCode?{authenticated:!1,message:o.message,errorCode:o.errorCode,instruction:o.instruction}:s(null,o)?e.reject(l(o)):{authenticated:!0,authToken:o.authToken}},function(){return e.reject(l(1e3))})}function c(n){if(n.authToken){var t={username:o,authToken:n.authToken};return i.updateSession(t),r.mergeToRegistrationData(t).then(function(){return e.when(n)})}return e.when(n)}var d=u.baseURL+"/service-auth/login/"+o;p.debug("Authenticating user with URL : "+d);var f={password:t};return a().then(c)},new h}]);