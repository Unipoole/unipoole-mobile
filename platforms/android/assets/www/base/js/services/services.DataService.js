"use strict";synthMobile.factory("DataService",["$q","$http","LoggerService","SynthError","UserSession","SynthConfig",function(e,t,n,r,o,i){function a(){this.deviceReady=!1,this.cachedRouteFileSystem=null}function c(e){return"string"==typeof e?JSON.parse(e):"object"==typeof e?e:(l.warn("Invalid object type : "+typeof e),null)}function u(e){return"string"==typeof e?(l.debug("Data type is string"),e):"object"==typeof e?(l.debug("Data type is object"),JSON.stringify(e)):(l.warn("Invalid object type : "+typeof e),null)}var l=n("DataService");return a.prototype.cordovaReady=function(){var t=e.defer();if(this.deviceReady===!0)t.resolve();else{var n=this;document.addEventListener("deviceready",function(){n.deviceReady=!0,t.resolve()},!1)}return t.promise},a.prototype.getApplicationRoot=function(){var t=e.defer(),n=this;return this.cordovaReady().then(function(){function e(e){e.root.getDirectory(i.dataDir,{create:!0,exclusive:!1},function(e){n.cachedRouteFileSystem=e,t.resolve(e)},function(e){l.warn("Failed to get application root : "+e),t.reject(r(1004,e.code))})}function o(e){l.warn("Failed to get filesystem, code:"+e.code),t.reject(r(1004,e.code))}window.requestFileSystem(LocalFileSystem.PERSISTENT,0,e,o)}),t.promise},a.prototype.checkAndCreateDirectory=function(t){var n=e.defer();return this.getApplicationRoot().then(function(e){function o(e){return e.length>0&&("."===e[0]||""===e[0])?(e=e.slice(1),o(e)):e}function i(e,a){if(a=o(a),0===a.length)return void n.resolve(e);var c=a[0];a=a.slice(1),e.getDirectory(c,{create:!0},function(e){a.length>0?i(e,a):n.resolve(e)},function(e){l.warn("Error creating path "+t+" : "+e),n.reject(r(1004,e))})}i(e,t?t.split("/"):[])}),n.promise},a.prototype.getLocalFilePath=function(){var t=e.defer();return this.getApplicationRoot().then(function(e){t.resolve(e.fullPath)},function(e){t.reject(r(1004,e))}),t.promise},a.prototype.writeToolData=function(t,n,o,i){var a=e.defer();return this.getDataDirectory(n,t).then(function(e){function t(e){e.onwriteend=function(){a.resolve()};var t=u(o);null!=t?e.write(t):(l.warn("Failed while trying to write tool data, Invalid data type given to write as tool data"),a.reject(r(1e3,"Invalid data type given to write as tool data")))}function c(e){l.warn("Failed while trying to write tool data, error : "+e),a.reject(r(1004))}var f=n+(i?".upload.json":".json");e.getFile(f,{create:!0,exclusive:!1},function(e){e.createWriter(t,c)},c)},function(){a.reject()}),a.promise},a.prototype.writeToFile=function(t,n,o){var i=e.defer();return this.checkAndCreateDirectory(t).then(function(e){function t(e){e.onwriteend=function(){i.resolve()};var t=u(o);e.write(t)}function a(e){l.warn("Failed while trying to write to file, error: "+e),i.reject(r(1004))}e.getFile(n,{create:!0,exclusive:!1},function(e){e.createWriter(t,a)},a)},function(e){l.warn("Failed while trying to write to file, error: "+e),i.reject(r(1004))}),i.promise},a.prototype.copyFromWebToFile=function(t,n,o){function i(e){c.writeToFile(n,o,e).then(function(){a.resolve()},function(e){l.warn("Failed while trying to copy file from web, error: "+e),a.reject(r(1004))})}var a=e.defer(),c=this;return this.getWebData(t).then(function(e){i(e)},function(e){l.warn("Failed to get web data : "+e),a.reject(r(1004))}),a.promise},a.prototype.mergeToToolData=function(t,n,o,i){var a=e.defer(),u=this;return this.getToolData(t,n,i).then(function(e){var l=c(o),f=jQuery.extend(!0,e,l);u.writeToolData(t,n,f,i).then(function(){a.resolve()},function(){a.reject(r(1004))})},function(){}),a.promise},a.prototype.mergeToFile=function(t,n,r){var o=e.defer(),i=this;return this.getFileData(t,n).then(function(e){var a=jQuery.extend(!0,e,r);i.writeToFile(t,n,JSON.stringify(a)).then(function(){o.resolve()},function(e){o.reject(e)})},function(e){o.reject(e)}),o.promise},a.prototype.getToolDirectory=function(t,n){var r=e.defer(),o=t+("base"===n?"/base":"/tools/"+n);return this.checkAndCreateDirectory(o).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},a.prototype.getDataDirectory=function(t,n){var r=e.defer();null==n&&(n=o.activeModule);var i=n+("base"===t?"/base":"/tools/"+t);return this.checkAndCreateDirectory(i+"/data").then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},a.prototype.getFileInToolData=function(t,n,o){var i=e.defer();return this.getDataDirectory(n,t).then(function(e){e.getFile(o,{create:!1},function(e){var t=new FileReader;t.onloadend=function(e){l.debug(e.target.result),i.resolve(e.target.result)},e.file(function(e){t.readAsDataURL(e)},function(){l.warn("Failed to get file from file entry"),i.reject(r(1004))})},function(){l.warn("Fail while trying to get file in directory"),i.reject(r(1004))})},function(e){i.reject(e)}),i.promise},a.prototype.getWebData=function(n){return t({method:"GET",url:n}).then(function(e){return e.data},function(){return e.reject(r(1004))})},a.prototype.getFileData=function(t,n){l.debug("Getting data for: directroy="+t+", filename="+n);var o=e.defer(),i=this;return this.checkAndCreateDirectory(t).then(function(e){e.getFile(n,{create:!0},function(e){i.getFileAsObject(e).then(function(e){l.isDEBUG()&&l.debug("Got data :"+JSON.stringify(e)),o.resolve(e)},function(e){o.reject(e)})},function(){l.warn("Fail while trying to get file in directory"),o.reject(r(1004))})},function(e){o.reject(e)}),o.promise},a.prototype.getModuleData=function(e){return this.getFileData(e,"module.json")},a.prototype.getRegistrationData=function(){return this.getFileData("","registration.json")},a.prototype.getSettingsData=function(){return this.getFileData("","settings.json")},a.prototype.ensureSettingsData=function(){function t(){return c.getWebData("base/data/settings.json").then(function(e){a=e})}function n(){return c.getSettingsData().then(function(e){return i=e})}function r(){return i=jQuery.extend(!0,a,i),e.when(i)}function o(){return c.mergeToSettingsData(i)}var i,a,c=this;return t().then(n).then(r).then(o).then(n)},a.prototype.mergeToModuleData=function(e,t){return this.mergeToFile(e,"module.json",t)},a.prototype.mergeToRegistrationData=function(e){return this.mergeToFile("","registration.json",e)},a.prototype.mergeToSettingsData=function(e){return this.mergeToFile("","settings.json",e)},a.prototype.getMergedToolData=function(t,n){function r(){return u.getToolData(t,n,!0).then(function(e){a=e})}function o(){return u.getToolData(t,n,!1).then(function(e){c=e})}function i(){var t=jQuery.extend(!0,a,c);return e.when(t)}var a,c,u=this;return r().then(o).then(i)},a.prototype.getToolUploadDataSize=function(t,n){function r(e){o.reject(e)}var o=e.defer();return this.getDataDirectory(n,t).then(function(e){var t=n+".upload.json";e.getFile(t,{create:!0},function(e){e.file(function(e){o.resolve(e.size)},r)},r)},r),o.promise},a.prototype.deleteToolUploadData=function(t,n){var o=e.defer();return this.getToolDataFile(t,n,!0).then(function(e){e.remove(function(){o.resolve()},function(){l.warn("Error deleting upload file"),o.reject(r(1004,"Error deleting upload file"))})},function(e){o.reject(e)}),o.promise},a.prototype.getToolDataFile=function(t,n,o){var i=e.defer();return this.getDataDirectory(n,t).then(function(e){var t=n+(o?".upload.json":".json");e.getFile(t,{create:!0},function(e){i.resolve(e)},function(e){l.warn("Error getting tool data file, error: "+e),i.reject(r(1004))})},function(e){i.reject(e)}),i.promise},a.prototype.getToolData=function(t,n,r){function o(e){i.reject(e)}l.debug("Getting data for tool : "+t+" - "+n);var i=e.defer(),a=this;return this.getToolDataFile(t,n,r).then(function(e){a.getFileAsObject(e).then(function(e){i.resolve(e)},o)},o),i.promise},a.prototype.getFileContentCDV=function(t){var n=e.defer();return window.resolveLocalFileSystemURL(t,function(e){e.file(function(e){var t=new FileReader;t.onloadend=function(e){n.resolve(e.target.result)},t.readAsText(e)},function(){n.reject(r(1004))})},function(){n.reject(r(1004))}),n.promise},a.prototype.getFileContent=function(t,n,i){function a(){return u.getDataDirectory(t,n).then(function(e){f=e})}function c(){var t=e.defer();return l.debug("Getting content of file: "+f.nativeURL+"/"+i),f.getFile(i,null,function(e){e.file(function(e){var n=new FileReader;n.onloadend=function(e){t.resolve(e.target.result)},n.readAsText(e)},function(){t.reject(r(1004))})},function(){t.reject(r(1004))}),t.promise}var u=this,f=null;return null==n&&(n=o.activeModule),a().then(c)},a.prototype.getFileAsObject=function(t){function n(e){l.warn("Failed getting file as object, error : "+e),o.reject(r(1004,e))}var o=e.defer();return t.file(function(e){var t=new FileReader;t.onloadend=function(e){if(""===e.target.result)o.resolve({});else try{o.resolve(angular.fromJson(e.target.result))}catch(t){l.warn("Failed to create object from json string : \n"+e.target.result),o.reject(r(1004))}},t.readAsText(e)},n),o.promise},a.prototype.doesFileExist=function(t){var n=e.defer();return this.getApplicationRoot().then(function(e){e.getFile(t,{create:!1},function(){n.resolve(!0)},function(){n.resolve(!1)})},function(e){n.reject(e)}),n.promise},a.prototype.deleteAllApplicationData=function(){var t=e.defer();return o.clearSession(),this.getApplicationRoot().then(function(e){e.removeRecursively(function(){t.resolve()},function(){t.reject(r(1004,"Error deleting all aplication data"))})},function(e){t.reject(e)}),t.promise},a.prototype.generateUID=function(){return"UNIPOOLE_xxxxxxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})},new a}]);